## teknonaturalist Setup.
## This file provides instructions and commands for setting up teknonaturalist fungal detection pipeline, using Snakemake or bash. 
## These instructions include quick sets of instructions for setting up Conda, Mamba, and Snakemake; 
## please refer to their respective help pages if more extensive setup or troubleshooting is needed.
## Conda: https://conda.io/projects/conda/en/latest/user-guide/index.html
## Mamba: https://mamba.readthedocs.io/en/latest/index.html
## Snakemake: https://snakemake.readthedocs.io/en/stable/

### Troubleshooting provided at the end of the document.

######################################################
### Snakemake installation and setup instructions ####
######################################################

teknonaturalist may be run using provided Snakemake and bash scripts. The program requires several programs that can be installed
### A. using Mamba (from mini forge) and Snakemake (recommended)
### B. using Conda/Mamba and Snakemake (not recommended)
### C. manually (may be used if Snakemake malfunctions)
NOTE: Mac devices equipped with ARM may require additional steps, which we include below. 
NOTE: Swapping the command 'conda' with 'mamba' (or vice versa) may be helpful in some cases. Ideally 'mamba' can be used for everything.

### Option 1. Docker - see README.md. This will cover Snakemake installation and teknonaturalist environment creation and activation.
	
### Option 2. Snakemake installation via Mamba installation
### A. Install Mamba using Miniforge, as noted here: 
# 	https://mamba.readthedocs.io/en/latest/installation/mamba-installation.html
# Miniforge is available here:
#	https://github.com/conda-forge/miniforge

### B. Install Snakemake, as noted here:
# 	https://snakemake.readthedocs.io/en/stable/getting_started/installation.html
# using these commands (if 'mamba' doesn't work, try using 'conda')
mamba activate base
#Note: The first time activating mamba, you may need to call it from the condabin directory. (e.g., <PATH>/miniforge3/condabin/mamba activate).
mamba create -c conda-forge -c bioconda -n snakemake snakemake

### Option 3. Snakemake installation via Mamba installation via Conda (not recommended)

# A. Install Conda, as noted here: 
#	https://conda.io/projects/conda/en/latest/user-guide/index.html

# B. Once Conda is installed, install Mamba using Conda:
conda install -n base -c conda-forge mamba

# C. Install Snakemake, as noted here:
# 	https://snakemake.readthedocs.io/en/stable/getting_started/installation.html
# using these commands (if 'mamba' doesn't work, try using 'conda')
mamba activate base
mamba create -c conda-forge -c bioconda -n snakemake snakemake

######################################################
####### tekonaturalist setup without Snakemake #######
######################################################

# Manual installation (may be used if Snakemake malfunctions)
# 1. Create the following directories should be created for intermediate files.

cd $PATH/teknonaturalist
mkdir data
mkdir data/trimmed1
mkdir data/trimmed2
mkdir data/trimmed3
mkdir data/QC
mkdir data/CQC
mkdir data/bwa
mkdir data/no.match
mkdir data/krakenout
mkdir data/krakenout2
mkdir data/blast
mkdir data/nonchimera
mkdir data/meta

# 2. Install all programs using the instructions provided in MANUAL_package_install_for_bash_script.txt. 
# It is necessary that the directory setup stays the same (see snakemake_directory_structure.png)

################################################################
## Create/activate teknonaturalist environment with Snakemake ## 
################################################################
# Only run after successful Snakemake setup. 

# 1. Navigate to provided 'teknonaturalist' directory. This is the working directory where virtually all commands will be run. The remaining setup and pipeline execution will be within this directory. There must be an environment.yaml file (provided) to activate the 'teknonaturalist' Snakemake environment. At least one Snakefile must also be present in order to run Snakemake.

export PATH=$PATH:/location/of/teknonaturalist/directory

cd $PATH/teknonaturalist

# 2. Verify that the provided environment.yaml and Snakefile files to the working directory ($PATH/teknonaturalist/). The environment.yaml file is used to create the mamba environment. The Snakefile is the fungal identification pipeline. 

# 3. Create the 'teknonaturalist' Snakemake environment. This will install the programs needed to set up and run the fungal detection pipeline in Snakemake. 

mamba env create --name teknonaturalist --file environment.yaml
# Note: if environment creation does not work, try first running:
# mamba activate base

# 4. Activate teknonaturalist Snakemake environment 
# NOTE: conda may be substituted for mamba.
mamba activate teknonaturalist

# Now that the teknonaturalist Snakemake environment is activated, all programs necessary are activated for database and assembly preparation (if desired), as well as fungal ITS detection with teknonaturalist! Note that teknonaturalist environment MUST BE ACTIVATED to run programs installed in this environment.

#################################################
### Installing basic databases and assemblies ###
### for teknonaturalist and DNAbarcoder setup ###
#################################################

# Download basic databases. 
You will customize these later for your host plant species. 

# Download databases to run teknonaturalist
osf -p j57fs clone .

# Download sample species (Betula nana) assembly to run teknonaturalist with sample file
osf -p vnh3b clone .

# Download premade ITS and 5.8S sequences for use with DNAbarcoder; move all to correct location.
osf -p 38uk2 clone .
mv osfstorage/* .
rm -r osfstorage

#### Create necessary directories
mkdir data
mkdir data/orig.fastqs
mkdir data/finalcombined
mkdir assembly
mkdir assembly/Betula.nana.assembly
mkdir database
mkdir database/univec
mkdir database/uchime_datasets
mkdir database/genbank
mkdir database/fungi
mkdir database/PLANiTS

#### Setup DNAbarcoder
git clone https://github.com/vuthuyduong/dnabarcoder.git
mkdir dnabarcoder/ITS.refs

#### Unpack database and assembly files using python scripts and remove clutter. 
#### This will produce the necessary file structure to run teknonaturalist.
python ./extract_teknonaturalist_databases.py
python ./extract_ITS.refs_database_for_dnabarcoder.py
rm *.tar.gz

######################
#### Next steps: #####
# Before teknonaturalist may be run, the assembly and database files need to be installed in the teknonaturalist/ directory. 
# Please see the Prep_taxon_specific_assembly_and_databases.sh and Manual_prep_of_non_taxon_specific_databases.txt files for more.
######################






